sleuth
分布式服务跟踪

eureka_server
微服务应用1(trace_1)
微服务应用2(trace_2)
mvn install报错

pom.xml实现跟踪
<dependency>
	<groupId>org.springframework.cloud</groupId>
	<artifactId>spring-cloud-starter-sleuth</artifactId>
</dependency>


启动注册中心与trace_1,trace_2访问:
http://127.0.0.1:9101/trace-1
观察控制台

注意restTemplate调用时服务名TRACE-2为大写


Logstash整合
新增bootstrap.properties,将spring.application.name=trace-1移动到该文件中.
由于logback-spring.xml的加载在application.properties之前

pom.xml
<dependency>
	<groupId>net.logstash.logback</groupId>
	<artifactId>logstash-logback-encoder</artifactId>
	<version>4.6</version>
</dependency>

新增编写logback-spring.xml放在resource下面(还可以使用LogstashTcpSocketAppender)

找不到此类
net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder

注意restTemplate调用时服务名trace-2为小写

在工程build目录下会生成对应应用名称的json文件


Zipkin整合:
服务端(zipkin_server)
http://localhost:9411

pom.xml在trace_1,trace_2中添加
<dependency>
	<groupId>org.springframework.cloud</groupId>
	<artifactId>spring-cloud-sleuth-zipkin</artifactId>
</dependency>

trace_1,trace_2应用application.properties中添加
spring.zipkin.base-url=http://localhost:9411

管理查看界面
http://localhost:9411



消息中间件收集
修改trace_1,trace_2
<dependency>
	<groupId>org.springframework.cloud</groupId>
	<artifactId>spring-cloud-sleuth-stream</artifactId>
</dependency>
<dependency>
	<groupId>org.springframework.cloud</groupId>
	<artifactId>spring-cloud-starter-stream-rabbit</artifactId>
</dependency>

application.properties去掉spring.zipkin.base-url=http://localhost:9411配置
添加如下：
spring.rabbitmq.host=localhost
spring.rabbitmq.port=5672
spring.rabbitmq.username=springcloud
spring.rabbitmq.password=123

zipkin-server服务端修改
<dependency>
	<groupId>org.springframework.cloud</groupId>
	<artifactId>spring-cloud-sleuth-zipkin-stream</artifactId>
</dependency>
<dependency>
	<groupId>org.springframework.cloud</groupId>
	<artifactId>spring-cloud-starter-stream-rabbit</artifactId>
</dependency>
<dependency>
	<groupId>io.zipkin.java</groupId>
	<artifactId>zipkin-autoconfigure-ui</artifactId>
</dependency>




数据储存(mysql)
zipkin-server服务端修改
pom.xml
zipkin-server服务端修改
<dependency>
	<groupId>org.springframework.boot</groupId>
	<artifactId>spring-boot-starter-jdbc</artifactId>
</dependency>
<dependency>
	<groupId>mysql</groupId>
	<artifactId>mysql-connector-java</artifactId>
</dependency>
<dependency>
	<groupId>org.jooq</groupId>
	<artifactId>jooq</artifactId>
	<version>3.8.0</version>
</dependency>
<!-- mysql存储依赖 -->
<dependency>
	<groupId>io.zipkin.java</groupId>
	<artifactId>zipkin-autoconfigure-storage-mysql</artifactId>
</dependency>

spring-cloud-sleuth-zipkin-stream包含了"mysql存储依赖"不需要再引入。
如果是基于http就需要引入"mysql存储依赖"

application.properties中添加(自动初始化表结构):
spring.datasource.schema=classpath:/mysql.sql
spring.datasource.url=jdbc:mysql://localhost:3306/zipkin
spring.datasource.username=root
spring.datasource.password=123
spring.datasource.continueOnError=true
spring.datasource.initialize=true

配置好后启动程序,会自动地为我们根据指定的sql文件来创建表结构,我们可以得到如下两张表
zipkin_spans : 存储span信息的表
zipkin_annotations : 存储annotations表

最后切换存储类型
zipkin.storage.type=mysql

测试请求trace-1,我们就可以看到mysql数据库的记录了
